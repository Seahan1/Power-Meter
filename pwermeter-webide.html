<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STM32 INA226 完整上位机</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #00e676; --blue: #2979ff; }
        body { font-family: 'Segoe UI', Consolas, monospace; background: var(--bg); color: var(--text); margin: 0; padding: 15px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* 顶部栏 */
        .header { background: var(--panel); padding: 12px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border: 1px solid #333; }
        .controls { display: flex; gap: 10px; align-items: center; }
        
        /* 按钮 */
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 13px; }
        .btn-con { background: var(--accent); color: #000; }
        .btn-con:hover { background: #00c853; }
        .btn-stop { background: #d32f2f; display: none; }
        .btn-csv { background: var(--blue); }
        .btn-csv:hover { background: #1565c0; }
        .btn-clear { background: #555; }
        
        select { background: #333; color: white; border: 1px solid #555; padding: 6px; border-radius: 4px; }

        /* 仪表盘 (显示大数字) */
        .dashboard { display: flex; gap: 15px; margin-bottom: 15px; }
        .card { flex: 1; background: var(--panel); padding: 15px; border-radius: 8px; border-left: 4px solid #555; display: flex; flex-direction: column; justify-content: center; }
        .card.vol { border-color: var(--accent); }
        .card.cur { border-color: var(--blue); }
        .card-title { font-size: 12px; color: #888; margin-bottom: 5px; }
        .card-value { font-size: 28px; font-weight: bold; font-family: 'Courier New', monospace; }
        
        /* 主区域 */
        .main { display: flex; flex: 1; gap: 15px; min-height: 0; }
        .chart-container { flex: 3; background: var(--panel); border-radius: 8px; padding: 10px; position: relative; border: 1px solid #333; }
        .log-container { flex: 1; background: #000; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; border: 1px solid #333; }
        
        /* 日志窗口 */
        #logWindow { flex: 1; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; color: #aaa; white-space: pre-wrap; }
        .log-entry { border-bottom: 1px solid #222; padding: 2px 0; }
        .log-ok { color: var(--accent); }
    </style>
</head>
<body>

<div class="header">
    <div style="display: flex; align-items: center; gap: 10px;">
        <h2 style="margin: 0; font-size: 18px;">STM32 INA226 Monitor</h2>
        <select id="baudRate">
            <option value="9600">9600</option>
            <option value="115200" selected>115200</option>
        </select>
    </div>
    <div class="controls">
        <button id="btnConnect" class="btn-con" onclick="connect()">连接设备</button>
        <button id="btnDisconnect" class="btn-stop" onclick="disconnect()">断开连接</button>
        <button class="btn-csv" onclick="exportCSV()">导出 CSV</button>
        <button class="btn-clear" onclick="clearData()">清空数据</button>
    </div>
</div>

<div class="dashboard">
    <div class="card vol">
        <span class="card-title">VOLTAGE (电压)</span>
        <span id="dispVol" class="card-value" style="color: var(--accent)">--.--- V</span>
    </div>
    <div class="card cur">
        <span class="card-title">CURRENT (电流)</span>
        <span id="dispCur" class="card-value" style="color: var(--blue)">--.---- A</span>
    </div>
</div>

<div class="main">
    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>
    <div class="log-container">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px;">
            原始数据日志 (Raw Log)
        </div>
        <div id="logWindow"></div>
    </div>
</div>

<script>
    // --- 全局变量 ---
    let port, reader;
    let keepReading = false;
    let textDecoder = new TextDecoder();
    let buffer = ""; 
    
    // 历史数据存储 (用于CSV导出)
    let historyData = [];

    // --- Chart.js 配置 ---
    const ctx = document.getElementById('myChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: '电压 (V)',
                    data: [],
                    borderColor: '#00e676',
                    borderWidth: 2,
                    pointRadius: 0, // 隐藏点，提升性能
                    tension: 0,     // 直线连接，不平滑
                    yAxisID: 'y'
                },
                {
                    label: '电流 (A)',
                    data: [],
                    borderColor: '#2979ff',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, 
            scales: {
                x: { display: false }, // 隐藏时间轴文本
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Voltage (V)', color: '#00e676' },
                    min: -0.2, // 【关键】强制显示负值区域，让0V线悬空
                    max: 4.0,  // 固定最大值
                    grid: { color: '#333' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Current (A)', color: '#2979ff' },
                    min: -0.05, // 【关键】同理
                    max: 1.0,
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });

    // --- 核心逻辑 ---

    // 1. 处理文本流
    function processText(chunk) {
        buffer += chunk;
        const lines = buffer.split(/\r?\n/);
        buffer = lines.pop(); // 保留未完成的行

        lines.forEach(line => {
            if (!line.trim()) return;
            
            addLog(line); // 打印原始日志

            // 正则解析：适配 Addr:0x80 | V=3.300 V | I=0.0000 A
            const regex = /V=([\d\.]+)\s*V.*I=([\d\.]+)\s*A/;
            const match = line.match(regex);

            if (match) {
                const vol = parseFloat(match[1]);
                const cur = parseFloat(match[2]);
                
                updateUI(vol, cur);
            }
        });
    }

    // 2. 更新界面 (图表 + 仪表盘 + 历史记录)
    function updateUI(vol, cur) {
        const timestamp = new Date().toLocaleTimeString();

        // A. 更新仪表盘 (大数字)
        document.getElementById('dispVol').innerText = vol.toFixed(3) + " V";
        document.getElementById('dispCur').innerText = cur.toFixed(4) + " A";

        // B. 记录历史数据 (给CSV用)
        historyData.push({
            time: new Date().toISOString(),
            voltage: vol,
            current: cur
        });

        // C. 更新图表
        if (chart.data.labels.length > 200) { // 限制显示点数
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }
        chart.data.labels.push(timestamp);
        chart.data.datasets[0].data.push(vol);
        chart.data.datasets[1].data.push(cur);
        chart.update('none');
    }

    // --- 功能函数 ---

    async function connect() {
        if (!navigator.serial) return alert("请使用 Chrome 或 Edge 浏览器");
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: parseInt(document.getElementById('baudRate').value) });
            
            document.getElementById('btnConnect').style.display = 'none';
            document.getElementById('btnDisconnect').style.display = 'inline-block';
            
            keepReading = true;
            readLoop();
        } catch (e) {
            alert("连接失败: " + e);
        }
    }

    async function disconnect() {
        keepReading = false;
        if (reader) await reader.cancel();
        if (port) await port.close();
        document.getElementById('btnConnect').style.display = 'inline-block';
        document.getElementById('btnDisconnect').style.display = 'none';
    }

    async function readLoop() {
        while (port.readable && keepReading) {
            reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        processText(textDecoder.decode(value));
                    }
                }
            } catch (e) { console.error(e); } 
            finally { reader.releaseLock(); }
        }
    }

    // --- CSV 导出逻辑 ---
    function exportCSV() {
        if (historyData.length === 0) return alert("没有数据可导出！");
        
        let csvContent = "data:text/csv;charset=utf-8,Time,Voltage(V),Current(A)\n";
        
        historyData.forEach(row => {
            csvContent += `${row.time},${row.voltage},${row.current}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "ina226_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function clearData() {
        historyData = [];
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.data.datasets[1].data = [];
        chart.update();
        document.getElementById('logWindow').innerHTML = "";
    }

    function addLog(text) {
        const win = document.getElementById('logWindow');
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerText = text;
        if (text.includes("V=")) div.classList.add('log-ok'); // 高亮有效数据
        win.appendChild(div);
        if (win.childElementCount > 100) win.removeChild(win.firstChild);
        win.scrollTop = win.scrollHeight;
    }
</script>
</body>
</html>
