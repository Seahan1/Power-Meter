<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPower - 定制量程版</title>
    <style>
        /* --- 深灰主题配置 --- */
        :root {
            --bg: #121212;          /* 背景极深灰 */
            --panel: #1e1e1e;       /* 面板深灰 */
            --border: #333333;      /* 边框色 */
            --text: #e0e0e0;        /* 主文字 */
            --accent: #00e676;      /* 强调色(绿) */
            
            /* 你的专属量程颜色 */
            --col-v: #fdd835;       /* 电压: 黄色 */
            --col-i: #00b0ff;       /* 电流: 亮蓝 */
            --col-p: #ff4081;       /* 功率: 粉红 */
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Consolas, monospace;
            margin: 0; padding: 15px;
            height: 100vh;
            display: flex; flex-direction: column;
            box-sizing: border-box;
        }

        /* 顶部栏 */
        .header {
            background: var(--panel);
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }

        /* 按钮样式 (确保可点击) */
        button {
            padding: 8px 18px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 14px;
            margin-left: 10px; transition: 0.2s;
        }
        .btn-con { background: var(--accent); color: #000; }
        .btn-con:hover { background: #00c853; }
        .btn-dis { background: #d32f2f; color: #fff; display: none; } /* 默认隐藏断开按钮 */
        
        select {
            padding: 8px; background: #2c2c2c; color: #fff;
            border: 1px solid #444; border-radius: 4px; outline: none;
        }

        /* 主布局 */
        .main-container {
            flex: 1; display: flex; gap: 15px; overflow: hidden;
        }

        /* 左侧示波器 */
        .scope-box {
            flex: 3; background: #000000;
            border: 1px solid var(--border); border-radius: 8px;
            position: relative;
            display: flex; flex-direction: column;
        }
        .scope-info {
            position: absolute; top: 10px; left: 10px;
            font-size: 12px; color: #666; pointer-events: none;
        }
        canvas { width: 100%; height: 100%; cursor: crosshair; }

        /* 右侧面板 */
        .side-panel {
            flex: 1; min-width: 280px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* 仪表盘卡片 */
        .card {
            background: var(--panel); padding: 15px;
            border-radius: 8px; border-left: 5px solid #555;
            display: flex; flex-direction: column;
        }
        .card label { font-size: 12px; color: #888; margin-bottom: 5px; font-weight: bold; }
        .card span { font-size: 26px; font-weight: bold; letter-spacing: 1px; }

        /* 日志窗口 */
        .log-box {
            flex: 1; background: #000;
            border: 1px solid var(--border); border-radius: 8px;
            overflow-y: auto; padding: 10px;
            font-size: 11px; line-height: 1.4; color: #aaa;
            font-family: 'Courier New', monospace;
        }
        .log-ok { color: var(--accent); }     /* 解析成功 */
        .log-raw { color: #555; }             /* 原始数据 */

    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 18px; font-weight: bold; display:flex; align-items:center; gap:10px;">
        <span style="color:var(--accent)">⚡</span> ProPower Monitor
    </div>
    <div>
        <select id="baud"><option value="115200">115200</option></select>
        <button id="btn-connect" class="btn-con" onclick="connectSerial()">连接设备</button>
        <button id="btn-disconnect" class="btn-dis" onclick="disconnectSerial()">断开连接</button>
    </div>
</div>

<div class="main-container">
    <div class="scope-box" id="scope-wrapper">
        <canvas id="chart"></canvas>
        <div class="scope-info">
            量程设定: <span style="color:var(--col-v)">0-3V</span> | 
            <span style="color:var(--col-i)">0-200mA</span> | 
            <span style="color:var(--col-p)">0-270mW</span>
        </div>
    </div>

    <div class="side-panel">
        <div class="card" style="border-color: var(--col-v);">
            <label>VOLTAGE (电压)</label>
            <span id="val-v" style="color: var(--col-v)">--.-- V</span>
        </div>
        <div class="card" style="border-color: var(--col-i);">
            <label>CURRENT (电流)</label>
            <span id="val-i" style="color: var(--col-i)">--.-- mA</span>
        </div>
        <div class="card" style="border-color: var(--col-p);">
            <label>POWER (功率)</label>
            <span id="val-p" style="color: var(--col-p)">--.-- mW</span>
        </div>

        <div class="log-box" id="log-window">
            <div style="color:var(--accent)">> 系统就绪。请点击右上角“连接设备”。</div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('log-window').innerHTML=''" style="flex:1; background:#333; color:#fff; margin:0;">清空日志</button>
            <button onclick="dataBuffer=[];" style="flex:1; background:#333; color:#fff; margin:0;">清空波形</button>
        </div>
    </div>
</div>

<script>
    // --- 1. 全局配置 & 量程设定 (关键修改点) ---
    // 根据你的要求设置最大量程，这决定了波形的高度
    const RANGE_V = 3.5;    // 设为 3.5V，以便 3V 不会顶到头
    const RANGE_I = 250.0;  // 设为 250mA，适配你的 10-200mA
    const RANGE_P = 300.0;  // 设为 300mW，适配你的 30-270mW

    const MAX_POINTS = 1000; // X轴保留点数
    let dataBuffer = [];
    let port, reader, keepReading = false;
    let serialBuffer = "";
    const textDecoder = new TextDecoder();

    // --- 2. 绘图引擎 (Canvas) ---
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('scope-wrapper');

    // 自动调整画布大小
    function resize() {
        canvas.width = wrapper.clientWidth;
        canvas.height = wrapper.clientHeight;
    }
    window.addEventListener('resize', resize);
    resize(); // 初始调用

    function draw() {
        const w = canvas.width;
        const h = canvas.height;
        
        // 清空背景
        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, w, h);

        // 画网格 (灰线)
        ctx.strokeStyle = "#222";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let x=w; x>0; x-=w/10) { ctx.moveTo(x,0); ctx.lineTo(x,h); } // 竖线
        for(let y=h; y>0; y-=h/5)  { ctx.moveTo(0,y); ctx.lineTo(w,y); } // 横线
        ctx.stroke();

        // 如果没数据，直接返回
        if(dataBuffer.length < 2) return;

        // --- 画线核心函数 ---
        // 这里的 range 就是上面定义的 3.5, 250, 300
        function plotLine(key, range, colorVar) {
            const color = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;

            // X轴步长
            const stepX = w / MAX_POINTS; 

            // 从右向左画
            let isFirst = true;
            for(let i = 0; i < dataBuffer.length; i++) {
                // index 0 是最旧的数据(在左边)，length-1 是最新的(在右边)
                // 我们想让最新的数据在最右边
                // x = w - ( (bufferLen - 1 - i) * step )
                const x = w - ((dataBuffer.length - 1 - i) * stepX);
                
                if (x < 0) continue; // 超出屏幕不画

                const val = dataBuffer[i][key];
                
                // Y轴坐标变换：值越大，Y坐标越小(向上)
                // y = h - ( (val / range) * h )
                let y = h - ((val / range) * h);
                
                // 限制 y 不超出边界 (防穿模)
                if (y < 0) y = 0;
                if (y > h) y = h;

                if(isFirst) { ctx.moveTo(x, y); isFirst = false; }
                else { ctx.lineTo(x, y); }
            }
            ctx.stroke();
        }

        // 分别画三条线
        plotLine('p', RANGE_P, '--col-p'); // 功率
        plotLine('i', RANGE_I, '--col-i'); // 电流
        plotLine('v', RANGE_V, '--col-v'); // 电压
    }

    // 动画循环
    function loop() {
        draw();
        requestAnimationFrame(loop);
    }
    loop();

    // --- 3. 串口逻辑 (修复按钮点击) ---
    
    // 连接函数 - 直接被 onclick 调用
    async function connectSerial() {
        if (!navigator.serial) return alert("浏览器不支持串口，请用 Chrome/Edge");

        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });

            // UI 切换
            document.getElementById('btn-connect').style.display = 'none';
            document.getElementById('btn-disconnect').style.display = 'inline-block';
            log(">>> 串口已连接", "#fff");

            keepReading = true;
            readLoop();
        } catch (err) {
            log("连接错误: " + err, "red");
        }
    }

    async function disconnectSerial() {
        keepReading = false;
        if(reader) await reader.cancel();
        if(port) await port.close();

        document.getElementById('btn-connect').style.display = 'inline-block';
        document.getElementById('btn-disconnect').style.display = 'none';
        log(">>> 串口已断开", "#fff");
    }

    async function readLoop() {
        while (port.readable && keepReading) {
            reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        processText(textDecoder.decode(value));
                    }
                }
            } catch (error) {
                console.error(error);
            } finally {
                reader.releaseLock();
            }
        }
    }

    // --- 4. 数据解析 (Log正常说明这里收到了数据) ---
    function processText(chunk) {
        serialBuffer += chunk;
        const lines = serialBuffer.split(/\r?\n/);
        serialBuffer = lines.pop(); // 保留未完结的行

        lines.forEach(line => {
            if (line.trim().length < 2) return;

            // 打印到 Log 证明收到了
            // log(line.trim(), "log-raw");

            // 正则提取 V, I, P
            const vMatch = line.match(/V=\s*([-]?[\d\.]+)/);
            const iMatch = line.match(/I=\s*([-]?[\d\.]+)/);
            const pMatch = line.match(/P=\s*([-]?[\d\.]+)/);

            if (vMatch || iMatch || pMatch) {
                log(line.trim(), "log-ok");

                // 获取上一个值，防止闪烁
                const last = dataBuffer.length > 0 ? dataBuffer[dataBuffer.length-1] : {v:0, i:0, p:0};

                const v = vMatch ? parseFloat(vMatch[1]) : last.v;
                const i = iMatch ? parseFloat(iMatch[1]) : last.i;
                const p = pMatch ? parseFloat(pMatch[1]) : last.p;

                // 更新 Buffer
                dataBuffer.push({v, i, p});
                if (dataBuffer.length > MAX_POINTS) dataBuffer.shift();

                // 更新大数字显示
                document.getElementById('val-v').innerText = v.toFixed(3) + " V";
                document.getElementById('val-i').innerText = i.toFixed(2) + " mA";
                document.getElementById('val-p').innerText = p.toFixed(2) + " mW";
            }
        });
    }

    // 辅助: 写日志
    function log(msg, colorClass) {
        const box = document.getElementById('log-window');
        const div = document.createElement('div');
        div.innerText = msg;
        if(colorClass) {
            if(colorClass.startsWith("#")) div.style.color = colorClass;
            else div.className = colorClass;
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        // 限制条数防止卡顿
        if(box.childElementCount > 100) box.removeChild(box.firstChild);
    }

</script>
</body>
</html>
