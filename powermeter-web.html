<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>STM32 万能容错监控端</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Consolas, monospace; background: #121212; color: #e0e0e0; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        
        /* 顶部控制栏 */
        .header { background: #1e1e1e; padding: 10px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border: 1px solid #333; }
        button { padding: 5px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; margin-left: 5px; }
        .btn-green { background: #00e676; color: #000; }
        .btn-red { background: #ff5252; color: #fff; display: none; }
        .btn-blue { background: #2979ff; color: #fff; }
        
        /* 仪表盘 */
        .dashboard { display: flex; gap: 10px; margin-bottom: 10px; }
        .card { flex: 1; background: #1e1e1e; padding: 10px; border-radius: 8px; border-left: 5px solid #555; text-align: center; }
        .card-val { font-size: 24px; font-weight: bold; display: block; margin-top: 5px; }
        
        /* 主区域 */
        .main { display: flex; flex: 1; gap: 10px; min-height: 0; }
        .chart-box { flex: 3; background: #1e1e1e; border-radius: 8px; padding: 5px; position: relative; border: 1px solid #333; }
        .log-box { flex: 1; background: #000; border-radius: 8px; border: 1px solid #333; overflow-y: auto; padding: 10px; font-size: 11px; white-space: pre-wrap; color: #aaa; }
        
        .log-match { color: #00e676; } /* 匹配成功显示绿色 */
        .log-fail { color: #ff5252; }  /* 匹配失败显示红色 */
    </style>
</head>
<body>

<div class="header">
    <strong>STM32 Monitor (Universal Mode)</strong>
    <div>
        <select id="baud"><option value="115200">115200</option><option value="9600">9600</option></select>
        <button class="btn-green" id="btnCon" onclick="connect()">连接</button>
        <button class="btn-red" id="btnDis" onclick="disconnect()">断开</button>
        <button class="btn-blue" onclick="exportCSV()">导出CSV</button>
    </div>
</div>

<div class="dashboard">
    <div class="card" style="border-color: #00e676;">
        <small>VOLTAGE</small>
        <span id="valV" class="card-val" style="color:#00e676">--</span>
    </div>
    <div class="card" style="border-color: #2979ff;">
        <small>CURRENT</small>
        <span id="valI" class="card-val" style="color:#2979ff">--</span>
    </div>
    <div class="card" style="border-color: #ff9100;">
        <small>POWER</small>
        <span id="valP" class="card-val" style="color:#ff9100">--</span>
    </div>
</div>

<div class="main">
    <div class="chart-box"><canvas id="chart"></canvas></div>
    <div class="log-box" id="log">等待连接...<br>请点击“连接”按钮。<br>右侧会显示原始数据。</div>
</div>

<script>
    let port, reader, keepReading = false;
    let historyData = [];
    const textDecoder = new TextDecoder();
    let buffer = "";

    // 图表初始化
    const chart = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'V', data: [], borderColor: '#00e676', borderWidth: 2, tension: 0, pointRadius: 0, yAxisID: 'y' },
                { label: 'I', data: [], borderColor: '#2979ff', borderWidth: 2, tension: 0, pointRadius: 0, yAxisID: 'y1' },
                { label: 'P', data: [], borderColor: '#ff9100', borderWidth: 2, tension: 0, pointRadius: 0, yAxisID: 'y2' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            scales: {
                x: { display: false },
                y:  { type:'linear', display:true, position:'left', min:-0.5, max:4.0, grid:{color:'#333'} },
                y1: { type:'linear', display:true, position:'right', min:-0.05, max:1.0, grid:{drawOnChartArea:false} },
                y2: { type:'linear', display:false, position:'right', min:0, max:2.0 } // 功率轴隐藏刻度
            }
        }
    });

    // 核心解析逻辑：分步提取，互不影响
    function processText(chunk) {
        buffer += chunk;
        const lines = buffer.split(/\r?\n/);
        buffer = lines.pop(); 

        lines.forEach(line => {
            if(line.length < 5) return;
            
            // 1. 尝试独立提取 V, I, P
            // 只要字符串里有 V=数字 就提取，不管位置在哪
            const vMatch = line.match(/V=\s*([\d\.]+)/);
            const iMatch = line.match(/I=\s*([\d\.]+)/);
            const pMatch = line.match(/P=\s*([\d\.]+)/);
            
            let v = null, i = null, p = null;
            let logMsg = line.trim();
            let isSuccess = false;

            if (vMatch) { v = parseFloat(vMatch[1]); isSuccess = true; }
            if (iMatch) { i = parseFloat(iMatch[1]); isSuccess = true; }
            if (pMatch) { p = parseFloat(pMatch[1]); isSuccess = true; }

            // 2. 如果至少提取到一个数据，就更新界面
            if (isSuccess) {
                updateUI(v, i, p);
                log(logMsg + " [OK]", "log-match");
            } else {
                // 如果全是乱码或者没有关键字
                log(logMsg + " [解析失败-格式不对]", "log-fail");
            }
        });
    }

    function updateUI(v, i, p) {
        const now = new Date().toLocaleTimeString();
        
        // 更新大字 (如果有值才更新)
        if(v !== null) document.getElementById('valV').innerText = v.toFixed(3) + " V";
        if(i !== null) document.getElementById('valI').innerText = i.toFixed(4) + " A";
        if(p !== null) document.getElementById('valP').innerText = p.toFixed(4) + " W";

        // 更新图表 (为保持对齐，没有的值填上一次的或0)
        const lastV = chart.data.datasets[0].data.slice(-1)[0] || 0;
        const lastI = chart.data.datasets[1].data.slice(-1)[0] || 0;
        const lastP = chart.data.datasets[2].data.slice(-1)[0] || 0;

        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(v !== null ? v : lastV);
        chart.data.datasets[1].data.push(i !== null ? i : lastI);
        chart.data.datasets[2].data.push(p !== null ? p : lastP);

        if(chart.data.labels.length > 200) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(d => d.data.shift());
        }
        chart.update('none');

        // 保存历史
        historyData.push({t:now, v:v, i:i, p:p});
    }

    // 基础功能
    async function connect() {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: parseInt(document.getElementById('baud').value) });
            document.getElementById('btnCon').style.display='none';
            document.getElementById('btnDis').style.display='inline-block';
            keepReading = true; readLoop();
        } catch(e) { alert(e); }
    }
    
    async function disconnect() {
        keepReading = false; 
        if(reader) await reader.cancel();
        if(port) await port.close();
        document.getElementById('btnCon').style.display='inline-block';
        document.getElementById('btnDis').style.display='none';
    }

    async function readLoop() {
        while(port.readable && keepReading) {
            reader = port.readable.getReader();
            try {
                while(true) {
                    const {value, done} = await reader.read();
                    if(done) break;
                    if(value) processText(textDecoder.decode(value));
                }
            } finally { reader.releaseLock(); }
        }
    }

    function exportCSV() {
        let csv = "Time,Voltage,Current,Power\n";
        historyData.forEach(d => csv += `${d.t},${d.v||0},${d.i||0},${d.p||0}\n`);
        const a = document.createElement('a');
        a.href = encodeURI("data:text/csv;charset=utf-8,"+csv);
        a.download = "data.csv"; a.click();
    }

    function log(msg, cls) {
        const div = document.createElement('div');
        div.innerText = msg;
        if(cls) div.className = cls;
        const box = document.getElementById('log');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        if(box.childElementCount > 100) box.removeChild(box.firstChild);
    }
</script>
</body>
</html>
