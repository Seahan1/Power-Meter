<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPower - 实验室专业版 (Debug Mode)</title>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --panel-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --border-color: #e5e7eb;
            
            /* 波形颜色 */
            --color-v: #d97706; /* 橙色 */
            --color-i: #2563eb; /* 蓝色 */
            --color-p: #db2777; /* 洋红 */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 顶部栏 --- */
        header {
            height: 50px; background-color: var(--panel-bg); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .brand { font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--accent-color); }
        .status-badge { font-size: 12px; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666; }
        .status-badge.on { background: #d1fae5; color: #065f46; }

        /* --- 主布局 --- */
        main { flex: 1; display: flex; overflow: hidden; }

        /* --- 左侧边栏 (包含日志) --- */
        .sidebar {
            width: 300px; background-color: var(--panel-bg); border-right: 1px solid var(--border-color);
            padding: 15px; display: flex; flex-direction: column; gap: 15px; z-index: 5;
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

        button {
            background: #fff; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px;
            cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s;
        }
        button:hover { background: #f9fafb; border-color: #ccc; }
        button.primary { background: var(--accent-color); color: #fff; border: none; }
        button.primary:hover { background: #059669; }
        button.danger { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        select { padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); outline: none; }

        /* 日志窗口样式 (新增) */
        .log-container {
            flex: 1; display: flex; flex-direction: column; min-height: 0; /* 允许 flex 子元素滚动 */
            border: 1px solid #333; border-radius: 6px; background: #111;
        }
        .log-header {
            background: #222; color: #ccc; padding: 4px 8px; font-size: 11px; 
            border-bottom: 1px solid #333; display: flex; justify-content: space-between;
        }
        .log-window {
            flex: 1; overflow-y: auto; padding: 8px; 
            font-family: 'Consolas', 'Courier New', monospace; font-size: 11px; line-height: 1.4;
            color: #aaa; white-space: pre-wrap;
        }
        /* 日志颜色 */
        .log-rx { color: #aaa; }
        .log-ok { color: #4ade80; } /* 解析成功 (绿) */
        .log-err { color: #f87171; } /* 解析失败 (红) */
        .log-info { color: #60a5fa; }

        /* --- 中间示波器 --- */
        .scope-container { flex: 1; display: flex; flex-direction: column; position: relative; background: #fff; }
        canvas { width: 100%; height: 100%; }

        /* --- 右侧仪表盘 --- */
        .dashboard {
            width: 220px; background: var(--panel-bg); border-left: 1px solid var(--border-color);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .meter-card {
            background: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .meter-label { font-size: 12px; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; }
        .meter-val { font-size: 24px; font-weight: 600; font-family: 'Segoe UI', sans-serif; color: var(--text-main); }
        .meter-unit { font-size: 12px; color: var(--text-muted); float: right; margin-top: 10px; }

        /* Toast */
        .toast-box { position: fixed; top: 60px; right: 20px; z-index: 99; }
        .toast { background: #fff; border-left: 4px solid var(--accent-color); padding: 10px 15px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 13px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" style="color:var(--accent-color)"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        ProPower <span>Lab</span>
    </div>
    <div class="status-badge" id="conn-status">未连接</div>
</header>

<main>
    <aside class="sidebar">
        <div class="control-group">
            <label>Serial Config</label>
            <div style="display:flex; gap:5px;">
                <select id="baud-rate" style="flex:1">
                    <option value="115200" selected>115200</option>
                    <option value="9600">9600</option>
                </select>
                <button id="btn-connect" class="primary" style="flex:1.5">连接</button>
            </div>
        </div>

        <div class="control-group">
            <label>Display</label>
            <div style="display:flex; gap:10px; font-size:12px;">
                <label style="color:var(--color-v)"><input type="checkbox" checked id="chk-v"> 电压 V</label>
                <label style="color:var(--color-i)"><input type="checkbox" checked id="chk-i"> 电流 I</label>
                <label style="color:var(--color-p)"><input type="checkbox" checked id="chk-p"> 功率 P</label>
            </div>
        </div>
        
        <div class="control-group">
            <label>Actions</label>
            <div style="display:flex; gap:5px;">
                <button onclick="exportCSV()" style="flex:1">导出CSV</button>
                <button onclick="clearData()" style="flex:1">清空</button>
            </div>
        </div>

        <div class="control-group" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <label>Serial Monitor (Debug)</label>
            <div class="log-container">
                <div class="log-header">
                    <span>RX Data</span>
                    <span style="cursor:pointer; color:#f87171;" onclick="document.getElementById('console').innerHTML=''">[Clear]</span>
                </div>
                <div id="console" class="log-window">
                    <div class="log-info">等待连接...<br>请点击上方“连接”按钮。</div>
                </div>
            </div>
        </div>
    </aside>

    <div class="scope-container" id="scope-wrapper">
        <canvas id="oscilloscope"></canvas>
        <div style="position:absolute; top:10px; right:15px; font-size:11px; color:#999; background:rgba(255,255,255,0.8); padding:2px 6px; border-radius:4px;">
            Scroll to Zoom X
        </div>
    </div>

    <aside class="dashboard">
        <div class="meter-card" style="border-left: 4px solid var(--color-v);">
            <div class="meter-label">VOLTAGE</div>
            <span class="meter-val" id="val-v">--.--</span> <span class="meter-unit">V</span>
        </div>
        <div class="meter-card" style="border-left: 4px solid var(--color-i);">
            <div class="meter-label">CURRENT</div>
            <span class="meter-val" id="val-i">--.--</span> <span class="meter-unit">mA</span>
        </div>
        <div class="meter-card" style="border-left: 4px solid var(--color-p);">
            <div class="meter-label">POWER</div>
            <span class="meter-val" id="val-p">--.--</span> <span class="meter-unit">mW</span>
        </div>
    </aside>
</main>

<div class="toast-box" id="toast-box"></div>

<script>
    // --- 1. 核心变量 ---
    const MAX_POINTS = 5000;
    let dataBuffer = [];
    let port, reader, keepReading = false;
    let serialBuffer = "";
    const textDecoder = new TextDecoder();
    
    // 视图状态
    let state = {
        zoom: 5,        // X轴缩放
        offset: 0,      // 偏移
        vEnabled: true,
        iEnabled: true,
        pEnabled: true
    };

    // --- 2. 串口通信与解析 (最关键部分) ---
    async function connect() {
        if (!navigator.serial) return alert("请使用 Chrome/Edge 浏览器");
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: parseInt(document.getElementById('baud-rate').value) });
            
            toggleBtn(true);
            log("串口已打开...", "log-info");
            keepReading = true;
            readLoop();
        } catch (e) {
            log("连接失败: " + e, "log-err");
        }
    }

    async function disconnect() {
        keepReading = false;
        if (reader) await reader.cancel();
        if (port) await port.close();
        toggleBtn(false);
        log("串口已关闭", "log-info");
    }

    async function readLoop() {
        while (port.readable && keepReading) {
            reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        const chunk = textDecoder.decode(value);
                        processChunk(chunk);
                    }
                }
            } catch (e) { console.error(e); } 
            finally { reader.releaseLock(); }
        }
    }

    function processChunk(chunk) {
        serialBuffer += chunk;
        const lines = serialBuffer.split(/\r?\n/);
        serialBuffer = lines.pop(); // 保留最后一行

        lines.forEach(line => {
            if (line.length < 2) return; // 忽略空行

            // --- 打印原始数据到日志窗口 ---
            // 这样你就能看到 STM32 到底发了什么！
            // log(line.trim(), "log-rx"); 

            // --- 增强版正则匹配 ---
            // 允许负数 ([-]?])，允许整数和小数 ([\d\.]+)
            // 只要格式中有 V=数字，I=数字，P=数字 即可，忽略单位
            const vMatch = line.match(/V=\s*([-]?[\d\.]+)/);
            const iMatch = line.match(/I=\s*([-]?[\d\.]+)/);
            const pMatch = line.match(/P=\s*([-]?[\d\.]+)/);

            if (vMatch || iMatch || pMatch) {
                // 如果能匹配到任意一个，就视为有效行
                log(line.trim() + " [OK]", "log-ok"); // 标记为绿色

                // 提取数值，如果没有匹配到则保持上一次的值 (防止归零)
                const last = dataBuffer.length > 0 ? dataBuffer[dataBuffer.length-1] : {v:0, i:0, p:0};
                
                const v = vMatch ? parseFloat(vMatch[1]) : last.v;
                const i = iMatch ? parseFloat(iMatch[1]) : last.i;
                const p = pMatch ? parseFloat(pMatch[1]) : last.p;

                addData(v, i, p);
            } else {
                // 如果完全匹配不到，标记为红色
                log(line.trim() + " [格式错误]", "log-err"); 
            }
        });
    }

    // --- 3. 数据管理 ---
    function addData(v, i, p) {
        const point = { t: Date.now(), v, i, p };
        dataBuffer.push(point);
        if (dataBuffer.length > MAX_POINTS) dataBuffer.shift();
        updateMeters(point);
    }

    function updateMeters(d) {
        document.getElementById('val-v').innerText = d.v.toFixed(3);
        document.getElementById('val-i').innerText = d.i.toFixed(2);
        document.getElementById('val-p').innerText = d.p.toFixed(2);
    }

    // --- 4. 绘图引擎 ---
    const canvas = document.getElementById('oscilloscope');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('scope-wrapper');

    function resize() {
        canvas.width = wrapper.clientWidth;
        canvas.height = wrapper.clientHeight;
        draw();
    }
    window.addEventListener('resize', resize);

    function draw() {
        const w = canvas.width;
        const h = canvas.height;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, w, h);

        // 绘制网格
        ctx.strokeStyle = "#f0f0f0";
        ctx.lineWidth = 1;
        for (let x=w; x>0; x-=50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
        for (let y=h; y>0; y-=50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

        if (dataBuffer.length < 2) return;

        // 定义 Y 轴缩放 (让曲线好看一点)
        // 假设 V范围 0-4V, I范围 0-500mA, P范围 0-2000mW
        // 将零点设在下方 10%
        const zeroY = h * 0.9;
        const rangeV = 4.0;
        const rangeI = 100.0; // 如果你电流很小，把这个数字改小，波形就会变大！
        const rangeP = 500.0; // 同上

        const scaleV = (h * 0.8) / rangeV;
        const scaleI = (h * 0.8) / rangeI;
        const scaleP = (h * 0.8) / rangeP;

        drawWave('v', state.vEnabled, '--color-v', scaleV, zeroY);
        drawWave('i', state.iEnabled, '--color-i', scaleI, zeroY);
        drawWave('p', state.pEnabled, '--color-p', scaleP, zeroY);
    }

    function drawWave(key, enabled, colorVar, scale, zeroY) {
        if (!enabled) return;
        const color = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;

        const endX = canvas.width;
        let first = true;

        // 步进优化，避免绘制太多点
        const step = Math.max(1, Math.floor(5 / state.zoom));

        for (let i = dataBuffer.length - 1; i >= 0; i -= step) {
            const idx = dataBuffer.length - 1 - i;
            const x = endX - (idx * state.zoom);
            if (x < 0) break;

            const val = dataBuffer[i][key];
            const y = zeroY - (val * scale);

            if (first) { ctx.moveTo(x, y); first = false; }
            else { ctx.lineTo(x, y); }
        }
        ctx.stroke();
    }

    function loop() { draw(); requestAnimationFrame(loop); }
    loop();
    resize();

    // --- 5. 交互与辅助 ---
    function log(msg, cls) {
        const box = document.getElementById('console');
        const div = document.createElement('div');
        div.className = cls || "";
        div.innerText = msg;
        box.appendChild(div);
        if (box.childElementCount > 200) box.removeChild(box.firstChild); // 限制日志行数
        box.scrollTop = box.scrollHeight;
    }

    function toggleBtn(connected) {
        const btn = document.getElementById('btn-connect');
        const badge = document.getElementById('conn-status');
        if (connected) {
            btn.innerText = "断开";
            btn.classList.add('danger');
            btn.onclick = disconnect;
            badge.innerText = "已连接";
            badge.classList.add('on');
        } else {
            btn.innerText = "连接";
            btn.classList.remove('danger');
            btn.onclick = connect;
            badge.innerText = "未连接";
            badge.classList.remove('on');
        }
    }

    // 复选框事件
    ['v', 'i', 'p'].forEach(k => {
        document.getElementById('chk-'+k).addEventListener('change', e => state[k+'Enabled'] = e.target.checked);
    });

    // 鼠标滚轮缩放
    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        state.zoom = Math.max(0.5, Math.min(50, state.zoom + (e.deltaY < 0 ? 1 : -1)));
    });

    // 导出CSV
    function exportCSV() {
        let csv = "Time,Voltage(V),Current(mA),Power(mW)\n";
        dataBuffer.forEach(d => csv += `${d.t},${d.v},${d.i},${d.p}\n`);
        const a = document.createElement('a');
        a.href = encodeURI("data:text/csv;charset=utf-8,"+csv);
        a.download = "data.csv"; a.click();
    }
    
    function clearData() {
        dataBuffer = [];
        log("数据已清空", "log-info");
    }
</script>
</body>
</html>
